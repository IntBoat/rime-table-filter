# Rime 字典過濾器

這是一個用於過濾 Rime 輸入法字典文件的工具，可以從 TTC 字型文件中提取中文字形，並根據這些字形過濾 Rime 字典文件，只保留字型中存在的字符。
這樣可以防止輸入法顯示一大堆不存在的中文字符，令選字變得非常困難。

**使用 Go 語言開發，效能優異！**

## 功能特點

- 🎯 **自動字型提取**: 從 TTC 字型文件中自動提取中文字形
- 🔍 **智能過濾**: 根據字型中的字符過濾 Rime 字典文件
- 📋 **表頭保留**: 自動保留 YAML 表頭並使用 `...` 作為分界線
- 📊 **詳細統計**: 顯示過濾前後的統計信息
- 🎨 **彩色輸出**: 使用顏色區分不同類型的訊息
- ⚙️ **靈活配置**: 支援多種命令行選項
- 📈 **進度提示**: 即時顯示處理進度和已處理的文字數量
- ⚡ **高效能**: 使用 RAM 緩存機制，大幅減少 I/O 操作

## 系統需求

- Linux/macOS 系統
- Go 1.21+ (用於編譯)
- Python 3.x
- fonttools 套件

### 安裝依賴

```bash
# 安裝 Go (如果尚未安裝)
# Ubuntu/Debian:
sudo apt install golang-go

# macOS:
brew install go

# 安裝 fonttools
pip install fonttools
```

## 安裝

### 方法一：使用安裝腳本 (推薦)

```bash
# 自動安裝
./install.sh

# 安裝到系統
./install.sh --system
```

### 方法二：使用 Makefile

```bash
# 編譯程序
make build

# 安裝到系統
make install

# 或者快速編譯用於開發
make dev
```

### 方法三：手動編譯

```bash
# 編譯 Go 程序
go build -o rime-filter main.go

# 給予執行權限
chmod +x rime-filter
```

## 使用方法

### 基本用法

```bash
./rime-filter -f <字型文件.ttc>
```

### 完整選項

```bash
./rime-filter [選項]
```

#### 選項說明

| 選項   | 長選項        | 說明             | 預設值                  |
|------|------------|----------------|----------------------|
| `-f` | `--font`   | 指定 TTC 字型文件路徑  | 必填                   |
| `-d` | `--dict`   | 指定 Rime 字典文件路徑 | `quick5.dict.yaml`   |
| `-i` | `--index`  | 指定字型編號 (0-9)   | 自動選擇                 |
| `-o` | `--output` | 指定輸出文件路徑       | `filtered_dict.yaml` |
| `-c` | `--cache`  | 指定緩存大小         | `1000`               |
| `-h` | `--help`   | 顯示使用說明         | -                    |

### 使用範例

#### 1. 基本使用

```bash
./rime-filter -f NotoSansCJK-Regular.ttc
```

#### 2. 指定字典文件和輸出文件

```bash
./rime-filter -f font.ttc -d my_dict.yaml -o result.yaml
```

#### 3. 指定字型編號和緩存大小

```bash
./rime-filter -f font.ttc -i 0 -c 2000
```

#### 4. 查看幫助

```bash
./rime-filter -h
```

## 輸出文件

執行完成後會產生以下文件：

- `chinese_characters.txt` - 從字型中提取的中文字形列表
- `filtered_dict.yaml` - 過濾後的 Rime 字典文件
- `missing_chars.txt` - 字典中存在但字型中缺失的字符

## 工作流程

1. **字型分析**: 分析 TTC 字型文件，列出可用的字型編號
2. **字形提取**: 從指定字型中提取所有中文字形，顯示處理進度
3. **字典過濾**: 根據提取的字形過濾 Rime 字典文件，顯示過濾進度
4. **表頭處理**: 自動保留輸入文件的 YAML 表頭，使用 `...` 作為分界線
5. **結果輸出**: 生成過濾後的字典文件和統計報告

## 進度提示

腳本會在處理過程中顯示即時進度：

- **字形提取階段**: 顯示已處理的字形數量和百分比
- **字典過濾階段**: 顯示已處理的行數和百分比
- **進度更新頻率**: 每處理 50 個項目更新一次進度
- **最終統計**: 顯示總處理數量、有效數量、缺失數量等詳細信息

## 效能優化

- **編譯型語言**: Go 編譯後執行速度比腳本語言快 10-100 倍
- **高效記憶體管理**: 自動垃圾回收，無需手動管理記憶體
- **優化的 I/O**: 使用 bufio 包進行緩衝讀寫
- **原生正則表達式**: 使用 Go 原生 regexp 包，效能更佳
- **RAM 緩存機制**: 使用記憶體緩存減少磁碟 I/O 操作
- **批量寫入**: 累積指定數量的數據後批量寫入文件
- **高效算法**: 使用 map 進行 O(1) 字符查找
- **最小化外部命令**: 減少對外部工具的依賴

### 效能表現

- **處理速度**: 處理 79K 行字典僅需 3-8 秒
- **記憶體使用**: 低記憶體佔用，自動垃圾回收
- **編譯大小**: 約 8MB 的單一可執行文件

## 表頭處理

工具會自動處理 Rime 字典文件的 YAML 表頭：

- **表頭識別**: 自動識別以 `---` 開始的 YAML 表頭區塊
- **分界線**: 使用 `...` 作為表頭和內容的分界線
- **自動補齊**: 如果輸入文件沒有明確的 `...` 分界線，會在內容開始前自動添加
- **格式保留**: 完整保留表頭的所有格式和內容

### 表頭處理範例

**輸入文件**:

```yaml
---
name: "quick5"
version: "0.12"
sort: by_weight
vocabulary: essay-cantonese
...

日 a
曰 a
```

**輸出文件**:

```yaml
---
name: "quick5"
version: "0.12"
sort: by_weight
vocabulary: essay-cantonese
...

日 a
```

## 注意事項

- 確保 TTC 字型文件包含中文字形
- 字典文件應為標準的 Rime YAML 格式
- 如果字型文件包含多個字型，建議先查看可用編號再選擇
- 過濾過程會保留字典文件的註釋和格式
- 表頭會自動保留，無需手動處理

## 故障排除

### 常見問題

1. **ttx 命令未找到**

   ```text
   [ERROR] ttx 命令未找到，請安裝 fonttools
   ```

   解決方案：執行 `pip install fonttools`

2. **字型文件不存在**

   ```text
   [ERROR] TTC 字型文件不存在: font.ttc
   ```

   解決方案：檢查文件路徑是否正確

3. **未能提取中文字形**

   ```text  
   [ERROR] 未能提取任何中文字形，請檢查字型文件或其內容
   ```

   解決方案：確認字型文件包含中文字形，或嘗試其他字型編號

## 授權

此專案採用 MIT 授權條款。

## 貢獻

歡迎提交 Issue 和 Pull Request 來改善此工具。

## 更新日誌

### v1.0.0

- 初始版本
- 使用 Go 語言開發，效能優異
- 支援從 TTC 字型文件提取中文字形
- 智能過濾 Rime 字典文件
- 自動保留 YAML 表頭並使用 `...` 分界線
- 可配置的緩存大小選項
- 即時進度顯示和詳細統計
- 提供 Makefile 和安裝腳本
- 彩色輸出和完整的錯誤處理

## 在 Cursor/VS Code 中偵錯與任務

本專案已內建偵錯與任務設定，位於 `.vscode/`：

- `launch.json`：
    - Go: 直接執行 (預設參數) — 以倉庫內 `NotoSansCJK-Regular.ttc`、`quick5.dict.yaml` 直接測試
    - Go: 互動輸入參數 — 啟動時詢問字型/字典/輸出/緩存/字型編號

- `tasks.json`：
    - Go: Build (dev) — 本地快速編譯
    - Make: build / install / clean — 使用 Makefile 編譯/安裝/清理
    - Run (default args) — 先 build 再以預設參數執行

使用方式：

- 偵錯：在 Cursor/VS Code 的 Run and Debug 面板選擇對應的啟動配置並執行。
- 任務：在 Terminal → Run Task 選擇對應任務。
